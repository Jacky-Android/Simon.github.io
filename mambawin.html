<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/55181594?v=4">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>Mamba in windows é…ç½®&nbsp;|&nbsp;Simonâ€™s Blogs</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="Mamba in windows é…ç½®">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ«£&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="https://avatars.githubusercontent.com/u/55181594?v=4"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="road.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ¤‘&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>2024å¹´æ·±åº¦å­¦ä¹ å­¦ä¹ è·¯çº¿</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ˜€&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>About me</span>
        </div>
      </a>
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="12.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ¤&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>è®­ç»ƒç¥ç»ç½‘ç»œçš„æŠ€å·§</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="HA.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ˜¶&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>HAFormerå¤ç°</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="ma.html">
        <div class="Navbar__Btn">
          
          <span>â€£ </span>
        </div>
      </a>
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;ğŸ«£&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">Mamba in windows é…ç½®</h1>
    
  </header>
  <article id="https://www.notion.so/041ccd4c04ba4ff3aa32ffec72d80cc3" class="PageRoot"><a id="https://www.notion.so/89338d8b2ffe4600b67047cd6d919afd" class="Page" href="https://www.notion.so/89338d8b2ffe4600b67047cd6d919afd"><div><div class="Page__Icon"><svg viewBox="0 0 30 30" style="width:1.1875em;height:1.1875em;fill:inherit;opacity:0.8"><g><path d="M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z"></path></g></svg></div><div class="Page__Title"><span class="SemanticStringArray"><span class="SemanticString">Winé…ç½®Mamba</span></span></div></div></a><h1 id="https://www.notion.so/a39c9320b668418d80df6930df080b67" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/a39c9320b668418d80df6930df080b67"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">vmamba block that runs efficiently on windows</span></span></h1><div id="https://www.notion.so/c98b33d8e2784a1aa1bcfdc503d717e4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Windowsé…ç½®çš„mamba ä¸èƒ½ä½¿ç”¨selective_scan_cudaï¼Œå¯¼è‡´éœ€è¦forå¾ªç¯ï¼Œè€Œå®˜æ–¹å®ç°æ‰§è¡Œäº†æ›´å¿«çš„å¹¶è¡Œæ‰«æï¼Œå¦å¤–è¿˜å…·æœ‰ç¡¬ä»¶æ„ŸçŸ¥èƒ½åŠ›ï¼ˆå¦‚ FlashAttentionï¼‰ï¼Œåœ¨winä¸Šè‰°éš¾æ‰§è¡Œ
ä¿®æ”¹ä¸º</span></span></p></div><pre id="https://www.notion.so/4de5835fa1464c65844bf0f73d8c6f12" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">def</span> <span class="token function">selective_scan</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> u<span class="token punctuation">,</span> delta<span class="token punctuation">,</span> A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">,</span> D<span class="token punctuation">)</span><span class="token punctuation">:</span>


        <span class="token punctuation">(</span>b<span class="token punctuation">,</span> l<span class="token punctuation">,</span> d<span class="token punctuation">)</span> <span class="token operator">=</span> u<span class="token punctuation">.</span>shape <span class="token comment">#(B,L,D)</span>
        n <span class="token operator">=</span> A<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment"># N</span>

        <span class="token comment"># einsum æ“ä½œå®é™…ä¸Šæ˜¯å°† delta å’Œ A å¼ é‡çš„æœ€åä¸¤ä¸ªç»´åº¦è¿›è¡ŒçŸ©é˜µä¹˜æ³•ï¼Œå¹¶åœ¨å‰é¢æ·»åŠ äº†ä¸¤ä¸ªç»´åº¦ï¼ˆb å’Œ lï¼‰</span>
        <span class="token comment"># torch.exp å‡½æ•°å¯¹è¿™ä¸ªå¼ é‡ä¸­çš„æ¯ä¸ªå…ƒç´ è¿›è¡ŒæŒ‡æ•°åŒ–ï¼Œå³å°†æ¯ä¸ªå…ƒç´ å–æŒ‡æ•°å€¼ã€‚</span>
        deltaA <span class="token operator">=</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>einsum<span class="token punctuation">(</span>delta<span class="token punctuation">,</span> A<span class="token punctuation">,</span><span class="token string">'b l d, d n -> b l d n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># (B,L,D) * (D,N) -> (B,L,D,N)</span>
        <span class="token comment"># å°† deltaã€B å’Œ u å¼ é‡çš„å¯¹åº”ä½ç½®å…ƒç´ ç›¸ä¹˜ï¼Œå¹¶åœ¨æœ€åä¸€ä¸ªç»´åº¦ä¸Šè¿›è¡Œæ±‚å’Œï¼Œè¾“å‡ºä¸€ä¸ªæ–°çš„å¼ é‡ã€‚</span>
        g <span class="token operator">=</span> B<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        B <span class="token operator">=</span> repeat<span class="token punctuation">(</span>B<span class="token punctuation">,</span> <span class="token string">"b g n l -> b l (g H) n"</span><span class="token punctuation">,</span> H<span class="token operator">=</span>A<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> B<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        deltaB_u <span class="token operator">=</span> einsum<span class="token punctuation">(</span>delta<span class="token punctuation">,</span> B<span class="token punctuation">,</span> u<span class="token punctuation">,</span> <span class="token string">'b l d, b l d n, b l d -> b l d n'</span><span class="token punctuation">)</span>  <span class="token comment"># (B,L,D)*(B,L,N)*(B,L,D)->(B,L,D,N)</span>

        <span class="token triple-quoted-string string">'''
        æ‰§è¡Œ selective scan (see scan_SSM() in The Annotated S4 [2])
        # æ³¨æ„ï¼Œä¸‹é¢çš„ä»£ç æ˜¯é¡ºåºæ‰§è¡Œçš„, ç„¶è€Œåœ¨å®˜æ–¹ä»£ç ä¸­ä½¿ç”¨æ›´å¿«çš„å¹¶è¡Œæ‰«æç®—æ³•å®ç°çš„(ç±»ä¼¼äºFlashAttentionï¼Œé‡‡ç”¨ç¡¬ä»¶æ„ŸçŸ¥æ‰«æ)ã€‚
        '''</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> d<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>deltaA<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        C <span class="token operator">=</span> repeat<span class="token punctuation">(</span>C<span class="token punctuation">,</span> <span class="token string">"B G N L -> B (G H) N L"</span><span class="token punctuation">,</span> H<span class="token operator">=</span>A<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> C<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        ys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token triple-quoted-string string">'''for i in range(l):  # è¿™é‡Œä½¿ç”¨forå¾ªç¯çš„æ–¹å¼åªç”¨æ¥è¯´æ˜æ ¸å¿ƒçš„é€»è¾‘ï¼ŒåŸä»£ç ä¸­é‡‡ç”¨å¹¶è¡Œæ‰«æç®—æ³•
            x = deltaA[:, i] * x + deltaB_u[:, i] # x(t + 1) = Ax(t) + Bu(t)
            #print(x.shape,C[:, :, :, i].shape)
            y = einsum(x, C[:, :, :, i], 'b d n, b d n -> b d') # y(t) = Cx(t)  (B,D,N)*(B,N)->(B,D)
            ys.append(y)
        y = torch.stack(ys, dim=1)  # å¤§å° (b, l, d_in)  (B,L,D)'''</span>
        x_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token triple-quoted-string string">'''for i in range(l):
            x = deltaA[:, i] * x + deltaB_u[:, i]  # x(t + 1) = Ax(t) + Bu(t)
            x_list.append(x.unsqueeze(1))  # æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œç¨åè¿›è¡Œæ‹¼æ¥

        x_concat = torch.cat(x_list, dim=1)  # åœ¨ç¬¬äºŒç»´åº¦ä¸Šæ‹¼æ¥æ‰€æœ‰çš„ x'''</span>
        <span class="token comment">#print(x_concat.shape,u.shape,C[:, :, :, i].shape)</span>
        x_concat <span class="token operator">=</span> deltaA <span class="token operator">*</span> x<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> deltaB_u
        <span class="token comment">#print(x_concat.shape,u.shape,C[:, :, :, l-1].shape)</span>
        y <span class="token operator">=</span> einsum<span class="token punctuation">(</span> x_concat<span class="token punctuation">,</span> C<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> l<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'b l d n,b d n->b l d'</span><span class="token punctuation">)</span>



        y <span class="token operator">=</span> y <span class="token operator">+</span> u <span class="token operator">*</span> D <span class="token comment"># y(t) = Cx(t)+Du(t)</span>
        y <span class="token operator">=</span> y<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> y <span class="token comment">#(B,L,D)</span>
</span></span></span></code></pre></article>
  <footer class="Footer">
  <div>&copy; Simonâ€™s Blogs 2022</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>